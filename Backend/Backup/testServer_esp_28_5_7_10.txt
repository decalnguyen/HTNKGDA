import asyncio
import websockets
import cv2
import struct

VIDEO_PATH = "video.mp4"
SERVER_URI = "ws://localhost:8000/ws/image"

async def send_video():
    async with websockets.connect(SERVER_URI, ping_interval=None,max_size=None) as websocket:
        print("[✓] Đã kết nối tới server")

        cap = cv2.VideoCapture(VIDEO_PATH)
        if not cap.isOpened():
            print("[!] Không mở được video.")
            return

        while True:
            ret, frame = cap.read()
            if not ret:
                print("[✓] Hết video.")
                break

            # Nén ảnh sang JPEG
            success, jpeg = cv2.imencode(".jpg", frame)
            if not success:
                print("[!] Không nén được khung hình.")
                continue

            jpeg_bytes = jpeg.tobytes()
            size_bytes = struct.pack(">I", len(jpeg_bytes))  # 4 byte độ dài ảnh

            # Gửi chuỗi: 4 byte độ dài + nội dung ảnh JPEG
            await websocket.send(size_bytes + jpeg_bytes)

            await asyncio.sleep(1 / 30)  # Gửi ~30 FPS

        cap.release()

if __name__ == "__main__":
    try:
        asyncio.run(send_video())
    except KeyboardInterrupt:
        print("\n[!] Dừng bởi người dùng.")
